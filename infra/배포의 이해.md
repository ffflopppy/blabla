### pm, vm 다른점은 무엇인가?

사내에서 인프라를 사용할때 pm이든 vm 인든 결국 빌려쓰는 물리장비 아닌가?

다만 다른점이 있다면 pm 은 os 부터 설치가 필요하다 정도. 
내가 쓰는 vm의 밑바닥에는 누군가의 물리장비가 있고, 그 장비도 서버실에 있을것. 

### pm 에서는 k8s를 사용할수 없을까? 
사용이 가능하지만 노드(pm)를 추가하려면 실제 장비를 구매 해야하기 때문에 시간이 오래걸리겠지.

결국 두개의 큰 차이점이라고하면 os(linux)를 깔아서 주느냐, 마냐의 차이 정도 일까.

----

## loadbalancer 란.
LB는 보통 물리장비. 
- LB 는 들어오는 모든 트래픽을 먼저 받게되고, 
- 네트워크 가장 앞단에서 높은 성능과 안정성을 필요로 함.
- gateway 같아서 spf 위험이 있기때문에 failover 구성 필요.

## alb, nlb 같은것들은 클라우드에서만 제공된다?
온프레미스의 경우 nginx, ha prox 또는 물리LB 장비가 있을것.

### nginx
 - 소프트웨어 LB(무료)
 - HA 구성시 별도 도구 필요
 
### HAProxy
- 소프트웨어 LB(무료)
- 성능: nginx 보다 빠름
- 설정: nginx 보다 어려움
- 높은 동시성 처리도 가능

### 물리 LB장비(F5, Citrix 등..)
- 전용 하드웨어(비쌈)
- 설치: 서버실에 물리장비
- 성능: 초당 수백만개 요청처리
- 관리: 웹 UI 

-----

### kubectl apply -f depolyment.yaml 실행 시 일어나는 일
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1 #허용되는 추가 Pod 개수 -> 정상 상태: 5개 , 배포 중 최대: 5 + 1 = 6개까지 허용
      maxUnavailable: 0
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: app
        image: my-app:v2
```
1 k8s 가 현재 상태 확인
- 현재 pod 5개 실행중(image: my-app:v1)
- 새 설정: (image: my-app:v1)
2. RollingUpdate 전략에 따라 배포 시작
  1) 새 pod 생성(image: v2)
  - [v1,v1,v1,v1,v1] -> [v1,v1,v1,v1,v1, **v2** ]
  - LB/Service 가 v2로도 요청 보냄
  - v2 Pod 가 정상 작동 하는지 확인(readiness probe)
  2) v2 pod가 정상이면, 기존 v1 pod1 개 드레인 시작
  - 드레인 중인 pod 로 들어오는 요청 차단
  - 진행중인 요청은 마무리 될때 까지 기다림(graceful termination)
  - v1 pod 1개 삭제
  - pod 상태 : [v1,v1,v1,v1, **v2** ]
  3) 새 pod 생성(image: v2)
  - 반복
3. 배포 완료
- kubectl apply 명령어 반환
- 모든 pod ready 상태 확인

### maxUnavailable:1 이었다면 
```
[v1, v1, v1, v1, v1]
↓ (v1 1개 드레인/삭제, 새 Pod 생성 안 함)
[v1, v1, v1, v1] ← 4개로 줄어듦 (maxUnavailable: 1)
↓ (새 Pod 1 생성)
[v1, v1, v1, v1, v2]
↓ (v1 1개 더 드레인/삭제)
[v1, v1, v1, v2]
↓ (새 Pod 1 생성)
```

----
# pm 장비에서 다짜고짜 셧다운을 하게 되면? 
- 진행중인 요청이 갑자기 끊김.
해결
1. LB에서 서버1 차단 (새 요청 차단)
2. 기존 요청들이 마무리될 때까지 기다림 (드레인)
3. 모든 요청이 끝났으면 그제야 서버1 셧다운
4. 배포 진행

----
물리 LB 장비는 안함
- 서버1에 기존 요청이 있는지 확인 안 함
- 기존 요청이 끝날 때까지 기다려주지 않음
- 드레인 작업을 자동화하지 않음

